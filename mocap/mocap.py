import cv2 as cv
import numpy as np
from matplotlib import pyplot as plt
from cv2 import sfm
from utils.extrinsic2pyramid.util.camera_pose_visualizer import CameraPoseVisualizer
from scipy import linalg, optimize
from scipy.spatial.transform import Rotation

# camera_params = [
#     {
#         "intrinsic_matrix": np.array([[268.44910572,   0.,123.62732067],
#                             [  0.,         268.34119126, 151.28826451],
#                             [  0.,           0.,           1.        ]]),    
#                              "distortion_coef": np.array([-1.25161962e-01,  2.54636857e-01,  1.05829587e-04, -1.41596261e-03, -2.35408488e-01]),
#         "rotation": 1
#     },
#     {
#         "intrinsic_matrix": np.array([[269.95158059,   0, 139.37072352],
#                              [  0,          270.09608831, 160.36482761],
#                              [  0,            0,            1,        ]]),        
#                              "distortion_coef": np.array([-1.17985085e-01,  1.73234197e-01,  1.48276201e-03,  1.31644936e-04, -9.25910705e-02]),
#         "rotation": 3
#     },
# ]
camera_params = [
    {
        "intrinsic_matrix": np.array([[268.66976067,   0.,120],
                            [  0.,        268.57495496, 160],
                            [  0.,           0.,           1.        ]]),      
                             "distortion_coef": np.array([0,0,0,0,0], dtype=np.float32()),
        "rotation": 1
    },
    {
        "intrinsic_matrix": np.array([[269.95158059,   0, 120],
                             [  0,          270.09608831, 160],
                             [  0,            0,            1,        ]]),         
                             "distortion_coef": np.array([0,0,0,0,0], dtype=np.float32()),
        "rotation": 3
    },
]

def get_camera_matrix(camera_num):
    w, h = 240, 320
    newcameramtx, roi = cv.getOptimalNewCameraMatrix(
        camera_params[camera_num]["intrinsic_matrix"], 
        camera_params[camera_num]["distortion_coef"], (w, h), 1, (w, h)
    )
    return newcameramtx

img1 = np.zeros((320,240), np.uint8)
img2 = np.zeros((320,240), np.uint8)

# random
# points = [
#     [[115, 137], [ 45, 141]],    [[221, 136], [203, 138]],    [[148,  29], [122,  27]],    [[ 31, 111], [198, 113]],    [[ 10, 273], [211, 293]],    [[ 10, 164], [ 70, 180]],    [[227, 139], [155, 140]],    [[ 24, 165], [213, 173]],    [[168, 158], [137, 160]],    [[ 96, 162], [ 28, 171]],    [[156, 140], [203, 143]]
# ]

# # 90 degree
# points = [
# [[222, 146], [127, 151]],[[218, 145], [129, 150]],[[211, 144], [131, 149]],[[205, 143], [134, 147]],[[198, 142], [136, 146]],[[195, 142], [137, 145]],[[189, 141], [139, 144]],[[183, 140], [141, 143]],[[177, 140], [142, 143]],[[172, 140], [143, 143]],[[167, 140], [143, 143]],[[165, 140], [144, 143]],[[160, 140], [144, 143]],[[156, 139], [144, 143]],[[151, 138], [144, 142]],[[147, 138], [145, 142]],[[141, 137], [145, 141]],[[139, 137], [145, 141]],[[134, 136], [144, 140]],[[130, 135], [144, 139]],[[124, 134], [144, 138]],[[119, 133], [145, 138]],[[117, 132], [145, 138]],[[111, 132], [145, 137]],[[107, 132], [145, 137]],[[103, 132], [145, 138]],[[98, 131], [145, 138]],[[94, 132], [145, 138]],[[88, 131], [145, 139]],[[86, 131], [145, 139]],[[82, 131], [145, 139]],[[78, 131], [144, 139]],[[72, 131], [143, 139]],[[68, 130], [143, 139]],[[61, 130], [142, 139]],[[58, 129], [142, 139]],[[53, 129], [142, 138]],[[47, 128], [141, 138]],[[40, 127], [141, 138]],[[34, 127], [141, 138]],[[30, 126], [141, 138]],[[25, 126], [142, 138]],[[19, 126], [142, 138]],[[15, 126], [143, 138]],[[12, 126], [143, 138]],[[7, 126], [143, 138]],[[3, 126], [144, 139]],[[73, 159], [4, 158]],[[74, 158], [8, 158]],[[76, 158], [12, 158]],[[76, 158], [15, 157]],[[76, 157], [20, 157]],[[77, 156], [25, 157]],[[78, 155], [30, 157]],[[78, 155], [35, 157]],[[78, 154], [38, 157]],[[79, 154], [42, 157]],[[79, 153], [47, 157]],[[79, 153], [53, 157]],[[79, 152], [58, 156]],[[79, 151], [63, 156]],[[78, 151], [67, 156]],[[78, 151], [71, 156]],[[77, 150], [76, 156]],[[77, 150], [80, 156]],[[77, 150], [85, 156]],[[77, 150], [91, 156]],[[77, 149], [96, 156]],[[77, 149], [99, 155]],[[78, 148], [105, 155]],[[78, 148], [110, 155]],[[78, 148], [115, 155]],[[78, 148], [122, 155]],[[78, 148], [124, 155]],[[79, 148], [130, 155]],[[79, 148], [135, 155]],[[80, 147], [142, 154]],[[81, 147], [148, 154]],[[82, 147], [154, 154]],[[83, 146], [162, 153]],[[83, 146], [165, 153]],[[83, 146], [171, 153]],[[84, 146], [177, 153]],[[84, 146], [184, 153]],[[84, 146], [190, 154]],[[85, 146], [196, 154]],[[86, 146], [203, 154]],[[87, 147], [208, 154]],[[87, 147], [211, 154]],[[87, 147], [218, 155]],[[88, 147], [225, 155]],[[90, 147], [233, 156]],[[66, 287], [149, 285]],[[67, 281], [148, 280]],[[68, 276], [147, 276]],[[69, 271], [146, 270]],[[69, 268], [145, 267]],[[70, 262], [144, 262]],[[70, 257], [144, 257]],[[71, 253], [143, 252]],[[72, 247], [142, 247]],[[72, 242], [141, 243]],[[73, 237], [140, 237]],[[73, 234], [140, 234]],[[74, 227], [139, 229]],[[74, 221], [139, 223]],[[74, 216], [139, 217]],[[75, 208], [139, 212]],[[75, 203], [139, 206]],[[75, 197], [140, 200]],[[75, 193], [140, 197]],[[75, 186], [141, 191]],[[75, 180], [141, 186]],[[74, 174], [142, 180]],[[74, 168], [142, 174]],[[74, 163], [143, 169]],[[73, 158], [143, 164]],[[73, 155], [143, 161]],[[73, 149], [143, 156]],[[73, 143], [143, 151]],[[73, 137], [143, 145]],[[73, 131], [143, 139]],[[73, 125], [144, 134]],[[74, 120], [144, 128]],[[74, 115], [145, 125]],[[74, 110], [146, 120]],[[75, 105], [147, 113]],[[75, 98], [148, 108]],[[75, 93], [149, 102]],[[75, 87], [150, 96]],[[76, 83], [150, 92]],[[76, 78], [152, 87]],[[76, 73], [152, 81]],[[76, 68], [154, 74]],[[76, 61], [155, 68]],[[76, 56], [157, 63]],[[76, 51], [159, 56]],[[101, 208], [222, 237]],[[99, 216], [215, 245]],[[96, 229], [201, 256]],[[90, 240], [185, 265]],[[83, 252], [171, 267]],[[76, 258], [158, 266]],[[67, 262], [143, 261]],[[61, 264], [136, 257]],[[48, 266], [127, 250]],[[36, 265], [119, 243]],[[25, 262], [112, 234]],[[13, 258], [108, 227]],[[2, 254], [105, 221]],[[8, 174], [135, 175]],[[20, 172], [145, 174]],[[27, 171], [151, 174]],[[40, 169], [162, 174]],[[49, 167], [173, 175]],[[56, 167], [188, 176]],[[64, 166], [199, 177]],[[69, 165], [211, 177]],[[73, 164], [225, 177]],[[76, 163], [231, 177]],[[103, 79], [230, 58]],[[97, 78], [209, 65]],[[94, 77], [200, 67]],[[88, 75], [184, 71]],[[83, 74], [166, 76]],[[80, 74], [157, 80]],[[73, 77], [144, 87]],[[65, 80], [132, 94]],[[56, 85], [120, 104]],[[44, 91], [111, 112]],[[32, 99], [103, 120]],[[20, 108], [96, 130]],[[9, 116], [93, 135]],[[6, 171], [125, 171]],[[26, 167], [127, 170]],[[42, 165], [129, 169]],[[60, 164], [133, 169]],[[77, 163], [140, 169]],[[95, 163], [149, 171]],[[108, 164], [161, 173]],[[117, 164], [172, 175]],[[125, 165], [189, 179]],[[131, 167], [214, 185]],[[12, 270], [94, 233]],[[28, 281], [95, 241]],[[37, 289], [95, 248]],[[96, 287], [145, 298]],[[111, 213], [189, 241]],[[109, 200], [193, 223]],[[106, 186], [194, 207]],[[104, 179], [193, 197]],[[98, 169], [190, 182]],[[91, 160], [183, 168]],[[81, 150], [175, 158]],[[70, 143], [167, 150]],[[57, 137], [157, 144]],[[40, 132], [148, 141]],[[31, 130], [144, 140]],[[15, 128], [137, 140]],[[52, 145], [191, 154]],[[58, 144], [178, 152]],[[67, 146], [168, 154]],[[72, 148], [160, 156]],[[79, 155], [149, 162]],[[86, 162], [137, 170]],[[94, 174], [125, 178]],[[101, 185], [115, 187]],[[107, 197], [104, 200]],[[113, 215], [95, 213]],[[115, 224], [91, 220]],[[117, 237], [88, 232]],[[116, 252], [87, 242]],[[113, 262], [89, 252]],[[110, 271], [93, 261]],[[105, 282], [96, 269]],[[102, 287], [98, 273]],[[97, 291], [104, 279]],[[69, 289], [132, 280]],[[65, 286], [137, 278]],[[60, 280], [145, 273]],[[53, 273], [152, 269]],[[49, 268], [158, 265]],[[44, 261], [166, 260]],[[40, 254], [172, 255]],[[38, 250], [176, 252]],[[35, 244], [183, 247]],[[49, 126], [195, 133]],[[52, 122], [191, 130]],[[54, 121], [187, 129]],[[57, 119], [181, 126]],[[61, 117], [173, 125]],[[65, 116], [166, 124]],[[68, 116], [160, 124]],[[71, 116], [152, 125]],[[73, 117], [149, 126]],[[77, 117], [143, 126]],[[80, 118], [138, 127]],[[83, 119], [131, 128]],[[88, 120], [126, 129]],[[92, 122], [121, 131]],[[97, 126], [116, 135]],[[100, 129], [114, 138]],[[107, 136], [110, 143]],[[113, 143], [104, 149]],[[120, 150], [97, 157]],[[128, 158], [91, 163]],[[135, 165], [86, 169]],[[141, 171], [79, 176]],[[145, 175], [76, 179]],[[151, 183], [71, 185]],[[155, 190], [67, 192]],[[157, 199], [65, 201]],[[157, 208], [66, 208]],[[156, 215], [67, 215]],[[154, 221], [69, 222]],[[151, 225], [71, 225]],[[146, 228], [76, 228]],[[140, 229], [83, 229]],[[133, 228], [89, 229]],[[126, 227], [96, 228]],[[119, 224], [104, 226]],[[114, 222], [108, 225]],[[107, 218], [116, 222]],[[100, 216], [124, 219]],[[92, 214], [132, 218]],[[85, 212], [138, 217]],[[77, 210], [145, 214]],[[72, 209], [148, 213]],[[64, 207], [152, 211]],[[57, 205], [156, 209]],[[49, 203], [159, 206]],[[40, 200], [160, 203]],[[33, 198], [160, 200]],[[25, 197], [157, 197]],[[17, 196], [155, 195]],[[131, 204], [232, 246]],[[135, 203], [222, 243]],[[138, 201], [212, 239]],[[139, 200], [206, 236]],[[140, 198], [195, 231]],[[139, 198], [185, 228]],[[136, 198], [174, 224]],[[133, 201], [161, 224]],[[126, 205], [149, 223]],[[118, 209], [138, 222]],[[109, 214], [129, 222]],[[101, 217], [126, 222]],[[90, 220], [121, 221]],[[79, 223], [117, 219]],[[66, 225], [115, 218]],[[57, 226], [113, 216]],[[52, 226], [111, 214]],[[44, 224], [106, 210]],[[43, 221], [104, 207]],[[46, 216], [100, 203]],[[53, 212], [98, 200]],[[66, 207], [97, 199]],[[80, 204], [99, 199]],[[91, 201], [102, 199]],[[104, 198], [108, 200]],[[115, 194], [118, 200]],[[126, 188], [128, 198]],[[131, 182], [139, 195]],[[133, 178], [150, 192]],[[134, 170], [168, 185]],[[133, 167], [175, 181]],[[131, 162], [182, 175]],[[129, 157], [181, 167]],[[125, 151], [172, 159]],[[120, 145], [159, 153]],[[117, 142], [148, 147]],[[109, 136], [133, 142]],[[98, 131], [120, 138]],[[87, 129], [111, 138]],[[75, 130], [102, 141]],[[61, 136], [96, 146]],[[49, 144], [90, 151]],[[39, 151], [87, 156]],[[26, 162], [84, 163]],[[14, 175], [84, 172]],[[1, 188], [84, 178]],[[2, 270], [92, 226]],[[68, 279], [104, 258]],[[80, 263], [119, 255]],[[93, 248], [135, 253]],[[101, 237], [151, 252]],[[105, 232], [164, 251]],[[111, 223], [181, 250]],[[116, 218], [197, 250]],[[119, 216], [217, 255]],[[121, 216], [232, 261]],[[1, 238], [101, 209]],[[15, 219], [106, 202]],[[26, 204], [111, 194]],[[37, 189], [120, 185]],[[48, 175], [128, 177]],[[56, 165], [136, 170]],[[61, 160], [144, 165]],[[70, 153], [154, 160]],[[76, 149], [164, 157]],[[82, 147], [177, 154]],[[89, 144], [188, 152]],[[92, 143], [194, 151]],[[97, 140], [204, 147]],[[102, 137], [213, 141]],[[107, 131], [221, 135]],[[111, 127], [229, 128]],[[114, 123], [234, 118]],[[120, 109], [232, 96]],[[120, 101], [221, 89]],[[117, 93], [206, 82]],[[113, 86], [186, 76]],[[106, 79], [171, 73]],[[102, 75], [163, 72]],[[93, 68], [152, 71]],[[84, 61], [142, 68]],[[73, 50], [135, 66]],[[85, 70], [232, 52]],[[99, 118], [222, 115]],[[97, 122], [207, 123]],[[93, 124], [187, 128]],[[88, 123], [171, 128]],[[85, 122], [162, 128]],[[78, 119], [147, 127]],[[71, 117], [133, 127]],[[62, 114], [124, 127]],[[53, 113], [118, 127]],[[45, 112], [112, 127]],[[33, 110], [109, 127]],[[27, 109], [107, 127]],[[16, 109], [104, 129]],[[6, 113], [101, 133]]
# ]

# # stereo
# points = [
# [[146, 150], [91, 157]],[[146, 153], [93, 161]],[[145, 152], [93, 160]],[[145, 152], [94, 159]],[[144, 151], [94, 159]],[[143, 151], [94, 159]],[[142, 151], [95, 159]],[[141, 151], [96, 159]],[[140, 151], [96, 159]],[[140, 151], [97, 159]],[[138, 151], [97, 159]],[[138, 151], [98, 159]],[[137, 151], [98, 158]],[[136, 150], [99, 158]],[[135, 150], [99, 158]],[[134, 149], [100, 158]],[[133, 149], [100, 157]],[[132, 148], [101, 156]],[[131, 148], [101, 156]],[[130, 147], [101, 155]],[[129, 146], [101, 154]],[[128, 146], [101, 154]],[[127, 145], [101, 153]],[[126, 145], [101, 153]],[[125, 145], [101, 153]],[[124, 145], [101, 153]],[[124, 146], [101, 154]],[[124, 146], [101, 154]],[[123, 147], [101, 155]],[[123, 148], [101, 156]],[[122, 148], [101, 157]],[[122, 149], [102, 157]],[[122, 150], [102, 158]],[[121, 151], [102, 159]],[[121, 151], [102, 159]],[[121, 152], [102, 160]],[[120, 152], [102, 161]],[[144, 259], [105, 272]],[[144, 254], [105, 268]],[[145, 248], [106, 263]],[[146, 243], [107, 257]],[[146, 240], [107, 254]],[[147, 234], [108, 248]],[[147, 229], [109, 242]],[[147, 224], [109, 237]],[[147, 218], [110, 231]],[[147, 213], [110, 226]],[[147, 209], [110, 221]],[[147, 205], [110, 217]],[[147, 201], [110, 213]],[[147, 197], [110, 208]],[[147, 193], [110, 204]],[[147, 188], [110, 198]],[[147, 183], [110, 194]],[[146, 179], [110, 189]],[[146, 175], [110, 185]],[[146, 171], [110, 181]],[[146, 166], [111, 176]],[[146, 162], [111, 172]],[[145, 158], [111, 167]],[[145, 153], [110, 161]],[[145, 148], [110, 156]],[[145, 143], [110, 151]],[[145, 140], [110, 148]],[[145, 135], [110, 143]],[[145, 130], [110, 138]],[[145, 126], [111, 133]],[[145, 120], [111, 127]],[[145, 116], [112, 123]],[[145, 112], [113, 118]],[[145, 109], [113, 115]],[[146, 104], [114, 110]],[[145, 100], [114, 106]],[[145, 96], [114, 102]],[[145, 92], [114, 97]],[[145, 88], [115, 93]],[[145, 84], [115, 89]],[[145, 82], [115, 86]],[[145, 77], [115, 82]],[[145, 74], [115, 78]],[[145, 71], [116, 75]],[[49, 160], [14, 168]],[[52, 162], [17, 170]],[[54, 163], [19, 170]],[[56, 163], [20, 170]],[[59, 163], [23, 171]],[[62, 164], [26, 172]],[[65, 164], [29, 172]],[[70, 165], [34, 173]],[[75, 166], [39, 174]],[[80, 166], [43, 174]],[[84, 167], [47, 175]],[[89, 167], [52, 175]],[[95, 168], [58, 176]],[[101, 168], [63, 177]],[[106, 169], [69, 177]],[[110, 169], [72, 178]],[[115, 169], [77, 178]],[[120, 170], [82, 178]],[[127, 170], [89, 179]],[[133, 170], [95, 179]],[[138, 170], [101, 180]],[[141, 170], [104, 180]],[[148, 170], [111, 180]],[[153, 170], [118, 180]],[[159, 170], [123, 180]],[[165, 170], [130, 181]],[[168, 170], [134, 181]],[[173, 171], [139, 181]],[[177, 170], [144, 181]],[[183, 171], [150, 181]],[[187, 171], [156, 182]],[[191, 172], [160, 183]],[[196, 173], [167, 184]],[[199, 173], [170, 185]],[[203, 175], [175, 186]],[[206, 176], [179, 188]],[[210, 177], [184, 190]],[[146, 84], [105, 88]],[[164, 91], [125, 96]],[[166, 94], [128, 99]],[[169, 98], [130, 103]],[[172, 102], [134, 108]],[[174, 106], [136, 112]],[[177, 110], [138, 116]],[[179, 115], [141, 122]],[[181, 118], [143, 125]],[[184, 123], [146, 130]],[[186, 128], [148, 135]],[[189, 133], [150, 140]],[[191, 138], [153, 146]],[[194, 145], [156, 153]],[[197, 150], [159, 159]],[[199, 156], [161, 166]],[[201, 163], [164, 173]],[[203, 169], [166, 180]],[[205, 175], [168, 186]],[[207, 182], [169, 193]],[[208, 188], [171, 202]],[[209, 197], [172, 210]],[[210, 204], [173, 218]],[[210, 212], [173, 225]],[[210, 218], [172, 233]],[[209, 224], [172, 239]],[[208, 230], [171, 245]],[[207, 235], [169, 251]],[[205, 240], [166, 256]],[[202, 244], [162, 260]],[[198, 248], [158, 263]],[[195, 250], [154, 266]],[[191, 253], [149, 269]],[[187, 254], [145, 271]],[[183, 256], [140, 273]],[[179, 258], [135, 275]],[[174, 260], [129, 276]],[[170, 261], [123, 277]],[[164, 261], [116, 276]],[[159, 260], [111, 275]],[[154, 259], [105, 274]],[[148, 258], [99, 272]],[[144, 256], [94, 270]],[[138, 254], [88, 268]],[[133, 251], [82, 264]],[[127, 248], [75, 260]],[[120, 243], [69, 255]],[[116, 238], [64, 250]],[[111, 233], [60, 244]],[[109, 228], [57, 239]],[[105, 222], [53, 233]],[[103, 216], [51, 226]],[[101, 211], [49, 220]],[[99, 203], [48, 213]],[[97, 197], [46, 206]],[[96, 190], [45, 199]],[[95, 186], [44, 193]],[[95, 177], [44, 185]],[[94, 170], [44, 177]],[[95, 163], [46, 170]],[[96, 156], [47, 164]],[[99, 149], [50, 156]],[[101, 143], [53, 150]],[[104, 139], [56, 146]],[[107, 134], [60, 140]],[[111, 129], [64, 136]],[[116, 125], [68, 131]],[[122, 121], [75, 127]],[[127, 118], [80, 124]],[[132, 115], [86, 121]],[[136, 113], [90, 120]],[[141, 111], [96, 117]],[[145, 109], [101, 115]],[[149, 108], [106, 114]],[[151, 70], [117, 74]],[[149, 73], [117, 78]],[[149, 74], [117, 78]],[[148, 73], [116, 77]],[[148, 73], [116, 77]],[[147, 72], [114, 76]],[[147, 73], [113, 77]],[[146, 73], [112, 78]],[[145, 75], [110, 79]],[[144, 76], [107, 80]],[[143, 77], [106, 81]],[[142, 78], [104, 83]],[[141, 81], [101, 86]],[[140, 85], [99, 90]],[[139, 89], [98, 94]],[[139, 95], [96, 100]],[[139, 98], [95, 104]],[[138, 103], [94, 109]],[[138, 109], [93, 115]],[[138, 116], [91, 122]],[[138, 122], [90, 128]],[[137, 128], [89, 135]],[[137, 135], [89, 142]],[[137, 142], [89, 150]],[[137, 146], [89, 154]],[[138, 154], [89, 161]],[[138, 161], [88, 171]],[[138, 169], [89, 178]],[[138, 176], [89, 185]],[[138, 182], [89, 191]],[[138, 187], [90, 198]],[[138, 194], [91, 204]],[[138, 197], [92, 208]],[[138, 203], [93, 214]],[[139, 209], [94, 221]],[[139, 215], [94, 226]],[[138, 219], [95, 231]],[[138, 223], [96, 236]],[[138, 227], [96, 240]],[[138, 229], [97, 242]],[[137, 232], [98, 244]],[[137, 233], [99, 246]],[[136, 234], [100, 247]],[[136, 233], [101, 247]],[[142, 162], [120, 171]],[[142, 160], [120, 169]],[[143, 158], [120, 167]],[[143, 156], [120, 164]],[[143, 153], [121, 162]],[[143, 151], [121, 159]],[[143, 149], [121, 157]],[[144, 146], [121, 154]],[[144, 144], [122, 153]],[[144, 142], [122, 150]],[[144, 140], [122, 148]],[[144, 138], [122, 145]],[[145, 136], [122, 143]],[[145, 134], [122, 141]],[[145, 132], [122, 139]],[[145, 130], [122, 137]],[[145, 128], [122, 134]],[[145, 125], [122, 131]],[[145, 121], [122, 128]],[[145, 119], [121, 125]],[[144, 116], [121, 123]],[[144, 113], [121, 119]],[[144, 111], [120, 117]],[[144, 108], [120, 114]],[[144, 105], [120, 111]],[[144, 102], [120, 107]],[[145, 99], [120, 105]],[[145, 96], [119, 101]],[[145, 92], [119, 98]],[[110, 188], [65, 197]],[[132, 191], [84, 201]],[[137, 191], [89, 202]],[[143, 193], [95, 203]],[[147, 194], [101, 205]],[[149, 195], [104, 206]],[[151, 196], [109, 207]],[[153, 196], [112, 208]],[[153, 197], [114, 208]],[[153, 197], [115, 208]],[[152, 197], [116, 208]],[[151, 197], [116, 208]],[[149, 197], [116, 208]],[[148, 197], [115, 208]],[[146, 197], [114, 208]],[[143, 197], [113, 208]],[[140, 197], [111, 208]],[[137, 197], [108, 208]],[[134, 197], [106, 208]],[[131, 196], [103, 207]],[[129, 196], [101, 207]],[[126, 196], [97, 206]],[[122, 196], [93, 206]],[[118, 195], [90, 205]],[[114, 195], [85, 205]],[[111, 194], [82, 204]],[[109, 194], [80, 203]],[[106, 193], [77, 203]],[[103, 192], [73, 202]],[[100, 191], [70, 201]],[[97, 190], [67, 199]],[[94, 189], [64, 198]],[[93, 189], [62, 197]],[[91, 188], [60, 197]],[[90, 187], [58, 196]],[[90, 186], [58, 195]],[[91, 185], [57, 195]],[[93, 185], [58, 194]],[[96, 184], [60, 193]],[[97, 184], [61, 193]],[[101, 183], [63, 193]],[[105, 183], [66, 192]],[[110, 183], [71, 192]],[[115, 184], [75, 193]],[[121, 184], [81, 194]],[[126, 185], [86, 194]],[[129, 185], [90, 195]],[[133, 184], [94, 194]],[[136, 183], [99, 193]],[[139, 182], [103, 192]],[[141, 180], [107, 191]],[[143, 179], [110, 189]],[[143, 178], [112, 188]],[[143, 178], [113, 188]],[[142, 177], [113, 187]],[[141, 176], [113, 186]],[[139, 175], [111, 184]],[[136, 173], [109, 183]],[[133, 172], [106, 181]],[[131, 170], [103, 179]],[[129, 169], [101, 178]],[[125, 168], [98, 176]],[[122, 166], [95, 174]],[[118, 164], [91, 172]],[[114, 161], [87, 169]],[[111, 158], [84, 166]],[[109, 157], [82, 164]],[[106, 154], [79, 162]],[[104, 152], [76, 159]],[[102, 149], [73, 156]],[[99, 146], [70, 153]],[[96, 143], [67, 150]],[[94, 140], [64, 147]],[[93, 138], [62, 145]],[[93, 137], [61, 144]],[[93, 135], [61, 141]],[[95, 133], [62, 140]],[[99, 132], [64, 139]],[[102, 131], [68, 138]],[[108, 131], [73, 138]],[[112, 131], [76, 138]],[[118, 132], [82, 139]],[[123, 133], [88, 140]],[[128, 133], [94, 140]],[[132, 133], [98, 140]],[[136, 133], [103, 140]],[[137, 133], [105, 140]],[[139, 133], [108, 140]],[[139, 132], [110, 139]],[[140, 132], [111, 139]],[[139, 131], [111, 138]],[[138, 130], [111, 136]],[[137, 128], [111, 135]],[[136, 127], [110, 134]],[[133, 125], [108, 132]],[[131, 124], [107, 131]],[[128, 122], [104, 129]],[[125, 120], [101, 126]],[[105, 87], [74, 92]],[[108, 86], [76, 91]],[[110, 86], [79, 91]],[[113, 86], [82, 91]],[[117, 86], [85, 91]],[[120, 87], [88, 92]],[[124, 88], [92, 93]],[[126, 88], [94, 93]],[[129, 89], [96, 94]],[[132, 89], [99, 94]],[[136, 89], [103, 94]],[[139, 90], [105, 95]],[[142, 90], [108, 96]],[[144, 91], [111, 96]],[[145, 92], [112, 97]],[[146, 92], [114, 98]],[[146, 93], [115, 98]],[[145, 93], [115, 98]],[[142, 92], [113, 98]],[[137, 91], [110, 96]],[[133, 91], [107, 96]]
# ]

# # a lot of points. pointing towards eachoter 90 degrees camera just out of frame
# points = [
#     [[85, 172], [127, 191]],    [[120, 179], [92, 200]],    [[183, 168], [62, 199]],    [[117, 154], [218, 170]],    [[120, 151], [203, 167]],    [[118, 150], [140, 170]],    [[158, 137], [161, 144]],    [[192, 108], [177, 46]],    [[178, 151], [196, 168]],    [[81, 135], [95, 165]],    [[39, 143], [78, 173]],    [[80, 130], [47, 170]],    [[57, 54], [46, 138]],    [[37, 266], [63, 231]],    [[72, 239], [103, 239]],    [[81, 218], [158, 239]],    [[118, 210], [187, 252]],    [[92, 187], [157, 210]],    [[154, 206], [186, 273]],    [[163, 158], [198, 181]],    [[174, 110], [164, 81]],    [[178, 84], [166, 15]],    [[166, 126], [109, 136]],    [[138, 137], [78, 163]],    [[113, 145], [63, 174]],    [[60, 120], [56, 163]],    [[131, 57], [51, 110]],    [[138, 24], [51, 80]],    [[125, 144], [64, 172]],    [[175, 171], [186, 215]],    [[198, 170], [113, 217]],    [[211, 171], [39, 207]],    [[210, 122], [33, 141]],    [[208, 83], [73, 35]],    [[169, 199], [190, 274]],    [[15, 151], [218, 165]],    [[13, 92], [216, 106]],    [[31, 63], [190, 81]],    [[67, 55], [136, 85]],    [[195, 171], [20, 198]],    [[170, 259], [39, 266]],    [[171, 233], [83, 277]],    [[169, 194], [148, 249]],    [[159, 175], [203, 220]],    [[138, 134], [132, 150]],    [[110, 84], [102, 112]],    [[50, 58], [72, 128]],    [[39, 60], [55, 139]],    [[153, 130], [58, 161]],    [[193, 123], [21, 157]],]

# # realistic setup 40 ish degree angle
# points = [
#     [[32, 171], [174, 161]],    [[33, 229], [178, 214]],    [[68, 184], [182, 176]],    [[31, 58], [147, 63]],    [[11, 141], [152, 134]],    [[151, 287], [10, 223]],    [[46, 149], [197, 143]],    [[207, 200], [34, 175]],    [[212, 109], [48, 96]],    [[125, 68], [25, 77]],    [[64, 102], [71, 102]],    [[155, 117], [150, 105]],    [[214, 105], [105, 86]],    [[216, 261], [105, 254]],    [[153, 289], [6, 222]],    [[18, 223], [72, 185]],    [[152, 162], [197, 157]],    [[120, 54], [36, 66]],    [[218, 114], [26, 101]],    [[219, 45], [10, 45]],    [[215, 291], [8, 238]],]

# # same position as above
# points = [
#     [[151, 140], [105, 128]],[[158, 120], [128, 108]],[[160, 119], [134, 107]],[[161, 120], [137, 107]],[[164, 122], [143, 109]],[[168, 127], [148, 114]],[[173, 134], [152, 121]],[[177, 142], [155, 131]],[[182, 153], [158, 143]],[[185, 163], [158, 155]],[[188, 175], [157, 169]],[[190, 187], [155, 183]],[[190, 198], [151, 194]],[[190, 207], [146, 204]],[[189, 215], [140, 211]],[[187, 222], [134, 216]],[[184, 227], [127, 219]],[[181, 230], [120, 220]],[[176, 231], [113, 218]],[[172, 229], [106, 213]],[[166, 224], [100, 206]],[[159, 215], [94, 196]],[[151, 206], [89, 185]],[[141, 194], [83, 173]],[[130, 182], [78, 161]],[[118, 170], [73, 150]],[[101, 154], [68, 140]],[[131, 115], [59, 109]],[[148, 123], [65, 112]],[[160, 127], [72, 116]],[[172, 132], [77, 119]],[[178, 134], [80, 120]],[[187, 136], [87, 122]],[[195, 137], [92, 123]],[[202, 137], [97, 122]],[[209, 136], [103, 122]],[[215, 135], [108, 120]],[[221, 134], [114, 118]],[[227, 133], [120, 116]],[[234, 131], [124, 113]],[[235, 242], [118, 244]],[[226, 245], [111, 242]],[[220, 245], [108, 240]],[[211, 246], [102, 237]],[[201, 246], [99, 234]],[[189, 246], [97, 231]],[[179, 246], [96, 228]],[[169, 244], [95, 224]],[[157, 240], [95, 219]],[[152, 238], [95, 217]],[[142, 234], [96, 212]],[[134, 231], [96, 207]],[[124, 226], [97, 203]],[[116, 222], [98, 199]],[[109, 217], [100, 194]],[[102, 211], [101, 190]],[[98, 208], [102, 187]],[[92, 204], [103, 182]],[[85, 200], [105, 179]],[[80, 197], [106, 176]],[[171, 107], [150, 91]],[[182, 110], [150, 93]],[[188, 112], [149, 95]],[[198, 116], [148, 98]],[[208, 120], [148, 102]],[[221, 126], [147, 108]],[[233, 131], [145, 113]],[[235, 157], [138, 145]],[[228, 162], [129, 152]],[[219, 164], [122, 153]],[[209, 164], [116, 152]],[[200, 163], [109, 151]],[[191, 161], [104, 148]],[[181, 155], [98, 142]],[[173, 148], [89, 134]],[[168, 144], [83, 130]],[[159, 136], [73, 123]],[[148, 128], [61, 118]],[[233, 145], [140, 131]],[[156, 265], [105, 244]],[[150, 261], [97, 236]],[[144, 257], [92, 230]],[[138, 252], [88, 223]],[[130, 246], [85, 217]],[[126, 242], [84, 213]],[[120, 235], [84, 205]],[[115, 227], [84, 198]],[[108, 216], [84, 191]],[[103, 206], [86, 180]],[[97, 196], [86, 173]],[[89, 185], [86, 165]],[[85, 178], [87, 160]],[[78, 170], [87, 152]],[[81, 235], [86, 201]],[[86, 225], [89, 196]],[[89, 222], [92, 194]],[[92, 221], [93, 194]],[[94, 222], [93, 195]],[[97, 228], [92, 200]],[[100, 237], [91, 208]],[[102, 248], [89, 216]],[[164, 268], [93, 244]],[[159, 263], [92, 238]],[[154, 256], [93, 232]],[[151, 250], [95, 226]],[[149, 243], [97, 220]],[[147, 236], [100, 214]],[[145, 229], [102, 209]],[[143, 220], [104, 202]],[[140, 214], [106, 195]],[[137, 209], [107, 191]],[[132, 203], [107, 186]],[[129, 199], [107, 181]],[[123, 191], [105, 173]],[[115, 185], [103, 168]],[[108, 182], [99, 164]],[[102, 181], [95, 164]],[[95, 184], [90, 164]],[[84, 189], [83, 166]],[[78, 192], [76, 168]],[[65, 199], [68, 171]],[[51, 208], [60, 175]],[[92, 111], [61, 107]],[[108, 109], [72, 104]],[[161, 118], [136, 104]],[[164, 121], [143, 107]],[[169, 128], [155, 116]],[[173, 135], [161, 123]],[[177, 147], [166, 136]],[[180, 160], [167, 149]],[[181, 168], [166, 158]],[[181, 182], [160, 176]],[[181, 192], [149, 187]],[[179, 200], [134, 192]],[[177, 202], [122, 192]],[[176, 201], [111, 188]],[[177, 195], [107, 181]],[[181, 187], [106, 175]],[[183, 184], [107, 172]],[[187, 175], [109, 163]],[[191, 166], [114, 154]],[[196, 156], [121, 143]],[[199, 146], [126, 133]],[[202, 138], [131, 124]],[[203, 134], [134, 119]],[[207, 129], [139, 113]],[[211, 125], [143, 108]],[[215, 123], [147, 105]],[[221, 123], [149, 104]],[[229, 125], [151, 106]],[[229, 188], [179, 192]],[[220, 185], [175, 186]],[[212, 182], [171, 181]],[[207, 181], [168, 178]],[[199, 179], [162, 174]],[[188, 177], [158, 171]],[[180, 174], [152, 167]],[[170, 171], [148, 163]],[[159, 169], [144, 159]],[[153, 167], [142, 157]],[[143, 164], [139, 153]],[[134, 161], [136, 150]],[[123, 161], [132, 149]],[[114, 162], [128, 150]],[[104, 162], [125, 149]],[[93, 159], [120, 147]],[[84, 156], [115, 143]],[[78, 154], [113, 141]],[[185, 261], [94, 243]],[[179, 256], [86, 235]],[[172, 252], [80, 228]],[[163, 249], [75, 221]],[[154, 245], [67, 214]],[[148, 243], [64, 210]],[[138, 239], [56, 203]],[[127, 236], [49, 197]],[[112, 230], [41, 190]],[[208, 212], [18, 180]],[[208, 203], [37, 177]],[[207, 194], [54, 174]],[[206, 188], [72, 171]],[[204, 182], [87, 168]],[[202, 176], [101, 165]],[[200, 174], [109, 163]],[[198, 169], [123, 158]],[[195, 165], [134, 155]],[[192, 162], [145, 152]],[[189, 158], [155, 150]],[[187, 157], [167, 148]],[[184, 155], [176, 147]],[[182, 155], [185, 147]],[[180, 154], [193, 147]],[[98, 173], [50, 152]],[[101, 177], [49, 154]],[[102, 179], [48, 155]],[[102, 182], [47, 157]],[[104, 184], [48, 159]],[[106, 185], [51, 160]],[[106, 182], [54, 158]],[[106, 178], [58, 156]],[[105, 175], [63, 154]],[[103, 171], [68, 151]],[[102, 169], [71, 150]],[[98, 166], [75, 149]],[[94, 163], [80, 146]],[[91, 159], [84, 143]],[[88, 155], [89, 142]],[[87, 154], [95, 141]],[[86, 153], [100, 141]],[[85, 153], [107, 141]],[[85, 153], [112, 141]],[[85, 152], [116, 140]],[[85, 151], [121, 140]],[[85, 150], [127, 139]],[[85, 149], [133, 138]],[[85, 147], [138, 137]],[[90, 136], [132, 127]],[[97, 139], [134, 130]],[[101, 141], [136, 131]],[[107, 142], [140, 132]],[[116, 143], [146, 133]],[[122, 146], [154, 136]],[[129, 148], [162, 138]],[[170, 137], [202, 126]],[[175, 142], [193, 132]],[[181, 151], [183, 139]],[[186, 160], [169, 151]],[[190, 169], [157, 160]],[[192, 176], [142, 168]],[[193, 180], [133, 171]],[[194, 184], [119, 174]],[[194, 190], [104, 177]],[[192, 195], [89, 179]],[[188, 199], [70, 179]],[[178, 195], [55, 173]],[[166, 188], [40, 162]],[[159, 183], [36, 158]],[[147, 173], [31, 149]],[[137, 164], [30, 142]],[[124, 153], [31, 136]],[[156, 209], [25, 176]],[[166, 198], [39, 170]],[[175, 190], [51, 167]],[[181, 186], [59, 166]],[[189, 183], [79, 166]],[[196, 184], [96, 170]],[[202, 189], [112, 178]],[[205, 196], [129, 190]],[[207, 205], [138, 201]],[[66, 205], [100, 180]],[[64, 189], [109, 169]],[[71, 170], [112, 155]],[[80, 162], [108, 148]],[[87, 161], [108, 147]],[[96, 161], [108, 147]],[[105, 161], [110, 148]],[[111, 162], [111, 149]],[[121, 164], [112, 151]],[[132, 167], [114, 154]],[[143, 170], [116, 157]],[[156, 176], [119, 162]],[[165, 181], [121, 169]],[[176, 187], [120, 177]],[[186, 199], [118, 189]],[[193, 209], [115, 200]],[[196, 216], [113, 207]],[[198, 230], [109, 221]],[[198, 245], [106, 235]],[[196, 265], [101, 249]],[[192, 280], [95, 263]],[[187, 294], [90, 272]],[[81, 202], [95, 178]],[[78, 187], [91, 167]],[[74, 175], [85, 155]],[[155, 232], [144, 224]],[[155, 229], [146, 222]],[[154, 225], [148, 218]],[[153, 221], [148, 215]],[[153, 218], [149, 210]],[[152, 214], [149, 207]],[[152, 210], [148, 202]],[[151, 208], [146, 199]],[[151, 204], [144, 195]],[[150, 199], [141, 189]],[[149, 194], [136, 184]],[[148, 190], [130, 178]],[[147, 184], [124, 172]],[[146, 180], [120, 168]],[[144, 175], [111, 161]],[[141, 170], [103, 155]],[[137, 163], [93, 149]],[[133, 158], [80, 142]],[[128, 153], [68, 139]],[[123, 153], [51, 138]],[[116, 162], [29, 143]],[[33, 224], [60, 184]],[[57, 245], [14, 187]],[[97, 252], [11, 195]],[[122, 252], [16, 198]],[[141, 248], [27, 201]],[[155, 243], [39, 203]],[[167, 237], [53, 205]],[[171, 234], [62, 206]],[[175, 230], [80, 208]],[[177, 226], [95, 209]],[[175, 222], [108, 209]],[[171, 219], [120, 208]],[[166, 216], [131, 206]],[[159, 213], [137, 203]],[[152, 210], [140, 200]],[[144, 207], [141, 196]],[[135, 204], [142, 193]],[[127, 202], [141, 190]],[[119, 200], [140, 187]],[[110, 198], [138, 185]],[[100, 196], [136, 182]],[[95, 195], [135, 181]],[[87, 194], [132, 178]],[[57, 215], [15, 171]],[[80, 224], [13, 176]],[[100, 230], [15, 182]],[[117, 233], [19, 187]],[[135, 236], [25, 192]],[[147, 237], [34, 196]],[[157, 237], [42, 200]],[[165, 237], [52, 204]],[[169, 236], [58, 206]],[[174, 235], [68, 209]],[[178, 233], [83, 212]],[[179, 231], [93, 213]],[[178, 229], [103, 214]],[[176, 227], [112, 214]],[[172, 224], [120, 212]],[[166, 221], [127, 210]],[[158, 217], [132, 206]],[[148, 213], [136, 202]],[[138, 209], [136, 197]],[[131, 207], [135, 194]],[[120, 203], [132, 189]],[[109, 201], [129, 185]],[[99, 199], [125, 182]],[[87, 197], [121, 180]],[[79, 197], [117, 178]],[[73, 197], [111, 176]],[[69, 197], [104, 175]],[[64, 198], [96, 175]],]

#another realistic
points = [
[[68, 134], [130, 144]],[[76, 121], [133, 131]],[[80, 119], [139, 129]],[[87, 119], [145, 128]],[[90, 120], [149, 128]],[[97, 122], [155, 129]],[[104, 125], [164, 132]],[[110, 129], [171, 136]],[[115, 134], [178, 142]],[[121, 141], [186, 150]],[[126, 148], [192, 159]],[[130, 155], [196, 168]],[[133, 165], [200, 180]],[[135, 173], [201, 191]],[[136, 177], [201, 200]],[[137, 187], [199, 210]],[[137, 194], [197, 219]],[[136, 201], [193, 228]],[[135, 209], [188, 237]],[[133, 214], [183, 243]],[[132, 217], [180, 246]],[[129, 223], [174, 252]],[[125, 228], [168, 256]],[[122, 232], [162, 258]],[[117, 235], [156, 259]],[[112, 238], [148, 259]],[[107, 239], [142, 258]],[[104, 241], [138, 257]],[[98, 242], [130, 256]],[[91, 243], [124, 254]],[[85, 243], [119, 251]],[[79, 242], [113, 247]],[[72, 240], [108, 242]],[[69, 238], [105, 240]],[[64, 235], [101, 234]],[[58, 231], [98, 230]],[[53, 226], [95, 224]],[[50, 220], [93, 218]],[[47, 212], [92, 209]],[[45, 202], [91, 202]],[[45, 197], [92, 198]],[[47, 190], [95, 192]],[[53, 183], [101, 187]],[[58, 178], [109, 184]],[[64, 174], [117, 181]],[[69, 170], [128, 178]],[[73, 166], [136, 175]],[[74, 164], [141, 173]],[[77, 159], [148, 169]],[[78, 155], [152, 165]],[[79, 150], [154, 160]],[[80, 146], [154, 154]],[[82, 141], [154, 150]],[[84, 138], [153, 148]],[[87, 135], [151, 143]],[[91, 132], [149, 140]],[[94, 129], [146, 138]],[[98, 128], [143, 136]],[[101, 128], [138, 135]],[[104, 127], [133, 134]],[[106, 127], [130, 134]],[[108, 127], [123, 135]],[[110, 129], [117, 136]],[[112, 132], [110, 139]],[[114, 136], [104, 144]],[[116, 143], [99, 152]],[[117, 153], [95, 160]],[[118, 158], [93, 166]],[[119, 167], [90, 175]],[[119, 176], [88, 185]],[[119, 188], [88, 195]],[[118, 198], [88, 205]],[[116, 207], [88, 214]],[[115, 216], [90, 225]],[[113, 223], [92, 230]],[[111, 230], [95, 237]],[[108, 235], [99, 243]],[[105, 239], [104, 248]],[[102, 242], [108, 251]],[[81, 168], [166, 180]],[[82, 166], [166, 178]],[[83, 163], [165, 175]],[[85, 161], [164, 172]],[[86, 157], [163, 168]],[[88, 154], [162, 164]],[[90, 150], [161, 160]],[[91, 146], [160, 156]],[[92, 142], [158, 151]],[[93, 138], [155, 147]],[[94, 136], [153, 145]],[[95, 134], [150, 142]],[[96, 132], [146, 140]],[[98, 131], [141, 140]],[[99, 132], [136, 140]],[[100, 134], [134, 142]],[[34, 159], [59, 164]],[[78, 170], [42, 172]],[[86, 170], [46, 173]],[[98, 171], [56, 175]],[[110, 172], [64, 177]],[[119, 173], [74, 180]],[[127, 174], [85, 182]],[[130, 175], [91, 184]],[[135, 176], [100, 186]],[[138, 177], [110, 188]],[[140, 177], [122, 191]],[[139, 177], [130, 191]],[[137, 177], [137, 192]],[[133, 177], [142, 192]],[[129, 177], [147, 191]],[[125, 176], [149, 191]],[[119, 175], [151, 190]],[[114, 175], [153, 189]],[[109, 174], [155, 188]],[[102, 174], [155, 187]],[[96, 173], [156, 186]],[[90, 173], [156, 185]],[[85, 172], [155, 184]],[[79, 172], [155, 183]],[[73, 172], [154, 183]],[[67, 172], [152, 182]],[[60, 171], [150, 181]],[[42, 172], [144, 181]],[[16, 168], [125, 175]],[[12, 167], [121, 173]],[[9, 165], [117, 172]],[[7, 164], [113, 170]],[[5, 163], [108, 169]],[[4, 161], [104, 167]],[[5, 159], [98, 165]],[[7, 158], [94, 164]],[[9, 156], [90, 163]],[[13, 155], [86, 161]],[[16, 154], [84, 161]],[[21, 153], [82, 160]],[[26, 153], [79, 160]],[[32, 152], [77, 159]],[[41, 152], [75, 159]],[[48, 152], [74, 159]],[[57, 153], [74, 160]],[[64, 154], [76, 161]],[[74, 155], [77, 162]],[[79, 178], [80, 163]],[[101, 159], [91, 167]],[[107, 160], [97, 168]],[[110, 160], [102, 169]],[[113, 160], [108, 169]],[[115, 159], [114, 169]],[[116, 157], [119, 167]],[[116, 155], [124, 165]],[[117, 154], [130, 164]],[[117, 152], [134, 162]],[[116, 150], [138, 160]],[[116, 148], [142, 158]],[[114, 146], [143, 155]],[[111, 143], [142, 152]],[[107, 139], [140, 149]],[[104, 136], [138, 146]],[[99, 132], [134, 141]],[[94, 128], [130, 137]],[[89, 123], [126, 131]],[[82, 117], [122, 127]],[[77, 112], [119, 122]],[[72, 106], [115, 116]],[[67, 102], [114, 114]],[[63, 96], [113, 109]],[[60, 92], [113, 106]],[[58, 88], [113, 103]],[[58, 82], [116, 97]],[[101, 62], [95, 74]],[[105, 64], [98, 74]],[[111, 67], [103, 76]],[[117, 70], [109, 77]],[[125, 74], [115, 79]],[[130, 78], [120, 80]],[[136, 81], [128, 81]],[[139, 82], [132, 82]],[[143, 84], [138, 82]],[[147, 86], [145, 83]],[[150, 87], [150, 83]],[[153, 88], [156, 82]],[[156, 88], [162, 81]],[[159, 88], [166, 80]],[[160, 88], [169, 80]],[[162, 88], [175, 78]],[[165, 88], [179, 77]],[[168, 89], [184, 76]],[[170, 90], [189, 77]],[[172, 91], [194, 78]],[[173, 93], [197, 78]],[[174, 93], [198, 79]],[[174, 93], [199, 79]],[[173, 94], [199, 81]],[[172, 96], [197, 85]],[[170, 101], [197, 91]],[[169, 105], [195, 97]],[[167, 110], [194, 106]],[[164, 117], [192, 114]],[[163, 120], [191, 119]],[[160, 125], [188, 126]],[[157, 130], [184, 134]],[[153, 135], [181, 140]],[[149, 138], [177, 146]],[[144, 142], [171, 150]],[[140, 145], [165, 155]],[[134, 150], [159, 159]],[[131, 152], [156, 162]],[[126, 156], [150, 167]],[[122, 161], [144, 174]],[[118, 169], [140, 180]],[[115, 176], [137, 187]],[[114, 182], [135, 195]],[[113, 189], [135, 204]],[[113, 197], [135, 211]],[[114, 202], [135, 216]],[[115, 208], [135, 223]],[[115, 215], [134, 233]],[[130, 240], [158, 269]],[[162, 262], [166, 310]],[[165, 263], [158, 310]],[[167, 262], [156, 309]],[[169, 260], [155, 307]],[[171, 257], [154, 304]],[[172, 256], [153, 303]],[[173, 254], [152, 300]],[[174, 252], [151, 298]],[[175, 251], [149, 295]],[[176, 248], [148, 293]],[[177, 247], [147, 291]],[[178, 247], [146, 291]],[[178, 248], [146, 291]],[[177, 249], [145, 293]],[[176, 251], [143, 294]],[[173, 254], [141, 295]],[[171, 255], [136, 294]],[[167, 255], [132, 292]],[[163, 255], [128, 289]],[[159, 255], [123, 286]],[[155, 256], [121, 284]],[[149, 256], [117, 282]],[[143, 257], [113, 280]],[[125, 257], [94, 268]],[[119, 258], [87, 265]],[[113, 259], [79, 262]],[[107, 262], [75, 261]],[[98, 266], [67, 260]],[[94, 268], [64, 260]],[[72, 262], [36, 242]],[[76, 260], [33, 241]],[[81, 261], [30, 241]],[[88, 262], [26, 242]],[[94, 263], [24, 244]],[[101, 264], [22, 246]],[[108, 265], [21, 248]],[[114, 265], [21, 249]],[[122, 263], [22, 250]],[[129, 259], [24, 249]],[[136, 254], [30, 248]],[[142, 247], [37, 246]],[[146, 241], [44, 243]],[[148, 235], [51, 239]],[[150, 230], [54, 236]],[[150, 223], [57, 230]],[[151, 217], [58, 224]],[[152, 211], [57, 217]],[[154, 206], [55, 214]],[[157, 205], [51, 211]],[[160, 204], [47, 210]],[[164, 203], [42, 209]],[[166, 202], [40, 208]],[[171, 201], [37, 207]],[[175, 200], [34, 206]],[[179, 198], [31, 205]],[[184, 196], [27, 203]],[[187, 195], [24, 201]],[[192, 193], [20, 200]],[[197, 194], [15, 200]],[[200, 194], [12, 201]],[[205, 195], [6, 202]],[[211, 197], [2, 203]],[[214, 194], [1, 200]],[[208, 190], [5, 197]],[[202, 187], [14, 193]],[[193, 184], [22, 190]],[[185, 179], [31, 186]],[[177, 176], [41, 183]],[[171, 173], [48, 180]],[[163, 169], [57, 177]],[[157, 166], [66, 174]],[[151, 163], [75, 170]],[[144, 160], [83, 168]],[[139, 159], [90, 168]],[[134, 159], [97, 167]],[[130, 157], [102, 166]],[[126, 156], [108, 165]],[[122, 156], [116, 165]],[[118, 156], [124, 165]],[[113, 156], [131, 166]],[[109, 155], [136, 166]],[[104, 154], [141, 165]],[[101, 153], [144, 164]],[[97, 152], [148, 163]],[[93, 152], [152, 162]],[[90, 152], [157, 163]],[[87, 153], [162, 164]],[[85, 154], [167, 165]],[[82, 154], [171, 165]],[[21, 150], [87, 158]],[[34, 151], [92, 158]],[[45, 151], [97, 159]],[[56, 151], [104, 160]],[[67, 152], [109, 160]],[[76, 152], [115, 161]],[[81, 153], [120, 162]],[[91, 154], [127, 163]],[[100, 154], [134, 164]],[[107, 155], [142, 166]],[[121, 157], [162, 169]],[[128, 157], [171, 170]],[[133, 158], [181, 171]],[[136, 158], [189, 172]],[[141, 158], [199, 174]],[[92, 284], [86, 281]],[[93, 265], [85, 264]],[[93, 246], [85, 247]],[[94, 228], [86, 227]],[[94, 207], [88, 211]],[[94, 197], [89, 202]],[[94, 182], [92, 185]],[[93, 164], [95, 171]],[[93, 150], [98, 158]],[[92, 137], [101, 143]],[[90, 122], [104, 131]],[[90, 114], [106, 124]],[[88, 102], [108, 110]],[[85, 87], [111, 98]],[[153, 138], [208, 143]],[[154, 143], [208, 151]],[[156, 153], [207, 165]],[[158, 163], [204, 182]],[[159, 176], [201, 197]],[[159, 185], [198, 211]],[[159, 195], [194, 224]],[[159, 206], [188, 240]],[[156, 225], [181, 262]],[[46, 240], [76, 230]],[[39, 228], [76, 218]],[[32, 222], [75, 214]],[[21, 218], [71, 209]],[[132, 249], [147, 277]],[[146, 242], [167, 279]],[[160, 268], [125, 303]],[[160, 263], [116, 294]],[[158, 257], [105, 283]],[[154, 252], [91, 270]],[[151, 247], [84, 263]],[[145, 243], [72, 253]],[[138, 240], [61, 245]],[[130, 238], [49, 237]],[[117, 236], [39, 231]],[[105, 237], [30, 227]],[[91, 237], [21, 222]],[[74, 195], [1, 187]],[[82, 193], [1, 186]],[[101, 190], [3, 185]],[[118, 189], [5, 186]],[[135, 189], [9, 188]],[[155, 189], [13, 190]],[[171, 189], [18, 192]],[[185, 188], [25, 195]],[[195, 187], [30, 195]],[[206, 185], [38, 196]],[[214, 181], [47, 193]],[[219, 175], [53, 187]],[[221, 166], [55, 179]],[[220, 159], [55, 170]],[[216, 152], [54, 161]],[[210, 146], [51, 152]],[[204, 141], [48, 148]],[[196, 137], [45, 143]],[[187, 133], [40, 139]],[[177, 130], [36, 137]],[[166, 127], [32, 134]],[[152, 124], [29, 133]],[[141, 121], [28, 131]],[[131, 117], [29, 127]],[[126, 114], [31, 126]],[[122, 112], [36, 124]],[[122, 111], [43, 123]],[[123, 110], [52, 121]],[[126, 109], [64, 119]],[[129, 107], [74, 116]],[[132, 106], [87, 114]],[[136, 106], [101, 112]],[[139, 106], [118, 110]],[[141, 107], [127, 110]],[[143, 109], [142, 111]],[[144, 111], [155, 112]],[[144, 113], [168, 114]],[[143, 116], [177, 117]],[[141, 118], [182, 120]],[[138, 121], [185, 124]],[[135, 122], [186, 125]],[[131, 123], [184, 128]],[[126, 124], [180, 129]],[[120, 124], [172, 129]],[[111, 121], [164, 128]],[[103, 118], [157, 125]],[[94, 113], [152, 121]],[[90, 110], [150, 118]],[[83, 107], [149, 115]],[[79, 105], [152, 113]],[[76, 103], [155, 111]],[[73, 101], [160, 110]],[[191, 199], [205, 240]],[[193, 189], [202, 227]],[[193, 185], [201, 220]],[[193, 179], [197, 209]],[[191, 173], [189, 198]],[[189, 166], [176, 186]],[[185, 160], [162, 177]],[[179, 153], [148, 166]],[[172, 146], [135, 156]],[[164, 138], [120, 144]],[[151, 129], [109, 136]],[[145, 126], [100, 132]],[[131, 120], [90, 128]],[[117, 113], [80, 123]],[[101, 104], [70, 116]],[[83, 93], [60, 108]],[[63, 80], [56, 102]],[[55, 75], [53, 98]],[[39, 65], [51, 93]]
]

points = np.int32(np.array(points))
pts1 = points[:,0]
pts2 = points[:,1] 

F, mask = cv.findFundamentalMat(pts1,pts2,cv.FM_RANSAC)

E = cv.sfm.essentialFromFundamental(F, camera_params[0]["intrinsic_matrix"], camera_params[1]["intrinsic_matrix"])
Rs, ts = cv.sfm.motionFromEssential(E)

visualizer = CameraPoseVisualizer([-1, 1], [-1, 1], [-1, 1])
visualizer.extrinsic2pyramid(np.eye(4), 'm', 0.2)
for i in range(0, 4):
    extrinsic = np.r_[np.c_[Rs[i], ts[i]], [[0,0,0,1]]]
    visualizer.extrinsic2pyramid(extrinsic, 'c', 0.2)
visualizer.show()

chosen_rt = 0

image_points = np.array([[[159, 96], [166, 90]],[[161, 104], [171, 99]],[[162, 108], [172, 104]],[[162, 113], [172, 111]],[[163, 118], [172, 117]],[[164, 121], [172, 122]],[[165, 127], [173, 130]],[[165, 134], [173, 140]],[[166, 142], [174, 150]],[[167, 150], [175, 162]],[[167, 158], [175, 172]],[[168, 166], [176, 182]],[[168, 173], [175, 194]],[[167, 181], [175, 203]],[[167, 185], [175, 209]],[[167, 191], [174, 219]],[[167, 199], [173, 228]],[[166, 205], [172, 237]],[[166, 211], [171, 244]],[[165, 216], [170, 250]],[[165, 219], [169, 255]],[[164, 221], [169, 258]],[[163, 221], [169, 259]],[[164, 220], [170, 256]],[[164, 216], [171, 252]],[[165, 211], [172, 244]],[[165, 205], [172, 237]],[[164, 201], [172, 232]],[[164, 195], [172, 224]],[[164, 190], [171, 215]],[[163, 184], [170, 208]],[[161, 178], [167, 200]],[[159, 173], [164, 192]],[[157, 168], [160, 184]],[[154, 163], [155, 178]],[[152, 162], [153, 175]],[[150, 159], [148, 171]],[[147, 158], [144, 170]],[[145, 159], [140, 170]],[[143, 161], [137, 174]],[[142, 166], [135, 179]],[[142, 169], [134, 182]],[[142, 175], [133, 188]],[[141, 180], [131, 195]],[[141, 186], [130, 203]],[[140, 193], [129, 209]],[[139, 199], [127, 215]],[[138, 205], [126, 222]],[[137, 210], [124, 229]],[[135, 214], [123, 231]],[[133, 217], [120, 234]],[[130, 218], [116, 234]],[[126, 216], [112, 231]],[[123, 213], [109, 226]],[[120, 208], [105, 218]],[[119, 203], [103, 214]],[[117, 197], [101, 207]],[[115, 190], [100, 198]],[[114, 182], [99, 191]],[[113, 175], [100, 184]],[[113, 170], [101, 178]],[[113, 166], [102, 174]],[[113, 164], [103, 173]],[[114, 164], [103, 173]],[[114, 167], [104, 176]],[[115, 172], [104, 181]],[[116, 177], [103, 186]],[[117, 184], [103, 194]],[[117, 189], [102, 198]],[[117, 196], [101, 205]],[[115, 202], [99, 213]],[[112, 210], [96, 219]],[[110, 215], [94, 223]],[[106, 218], [91, 225]],[[104, 219], [90, 225]],[[109, 146], [102, 155]],[[112, 145], [99, 154]],[[113, 146], [101, 154]],[[114, 145], [101, 154]],[[114, 144], [102, 153]],[[114, 144], [101, 153]],[[114, 145], [101, 154]],[[114, 147], [102, 156]],[[113, 150], [102, 158]]
                ])

def triangulate_points(image_points, r1, t1, r2, t2):

    #RT matrix for C1 is identity.
    RT1 = np.c_[r1, t1]
    P1 = camera_params[0]["intrinsic_matrix"] @ RT1 #projection matrix for C1

    #RT matrix for C2 is the R and T obtained from stereo calibration.
    RT2 = np.c_[r2, t2]
    P2 = camera_params[1]["intrinsic_matrix"] @ RT2 #projection matrix for C2

    # https://temugeb.github.io/computer_vision/2021/02/06/direct-linear-transorms.html
    def DLT(P1, P2, point1, point2):

        A = [point1[1]*P1[2,:] - P1[1,:],
            P1[0,:] - point1[0]*P1[2,:],
            point2[1]*P2[2,:] - P2[1,:],
            P2[0,:] - point2[0]*P2[2,:]
            ]
        A = np.array(A).reshape((4,4))

        B = A.transpose() @ A
        U, s, Vh = linalg.svd(B, full_matrices = False)

        return Vh[3,0:3]/Vh[3,3]
    
    object_points = []
    for image_points_1, image_points_2 in image_points:
        object_points.append(DLT(P1, P2, image_points_1, image_points_2))
    object_points = np.array(object_points)

    return object_points

def visualize(image_points, object_points, r1, t1, r2, t2):
    visualizer2 = CameraPoseVisualizer([-1, 1], [-1, 1], [0, 2])
    extrinsic1 = np.r_[np.c_[r1, t1], [[0,0,0,1]]]
    visualizer2.extrinsic2pyramid(extrinsic1, 'm', 0.2)
    extrinsic2 = [[-1,0,0,0],[0,-1,0,0],[0,0,1,0],[0,0,0,1]] @ np.r_[np.c_[r2, t2], [[0,0,0,1]]]
    visualizer2.extrinsic2pyramid(extrinsic2, 'c', 0.2)

    visualizer2.ax.scatter(object_points[:,0], object_points[:,1], object_points[:,2])

    def draw_line(ax, start, end):
        ax.plot([start[0], end[0]], [start[1], end[1]], [start[2], end[2]])

    def draw_ray_from_image_point(ax, intrinsic, extrinsic, image_point, daw):
        [[fx, _ , ox],
        [_ , fy, oy],
        [_ , _ , _ ]] = intrinsic
        
        f = np.mean([fx, fy])

        camera_point = extrinsic @ np.array([0,0,0,100]).T
        if daw:
            ray_end_point = extrinsic @ np.array([ox-image_point[0], oy-image_point[1], f, 100]).T
        else:
            ray_end_point = extrinsic @ np.array([image_point[0]-ox, image_point[1]-oy, f, 100]).T

        draw_line(ax, camera_point[:-1]/camera_point[-1], ray_end_point[:-1]/ray_end_point[-1])

    draw_ray_from_image_point(visualizer2.ax, camera_params[0]["intrinsic_matrix"], extrinsic1, image_points[0][0], False)
    draw_ray_from_image_point(visualizer2.ax, camera_params[1]["intrinsic_matrix"], extrinsic2, image_points[0][1], True)


    [[projected_img_point]], _ = cv.projectPoints(object_points[0], r1, t1, camera_params[0]["intrinsic_matrix"], camera_params[0]["distortion_coef"])
    draw_ray_from_image_point(visualizer2.ax, camera_params[0]["intrinsic_matrix"], extrinsic1, projected_img_point, False)
    [[projected_img_point]], _ = cv.projectPoints(object_points[0], r2, t2, camera_params[1]["intrinsic_matrix"], camera_params[1]["distortion_coef"])
    draw_ray_from_image_point(visualizer2.ax, camera_params[1]["intrinsic_matrix"], extrinsic2, projected_img_point, True)


    visualizer2.show()



def residuals(params, viz=False):
    r1 = np.eye(3)
    t1 = np.array([0,0,0], dtype=np.float32)
    r2 = Rotation.as_matrix(Rotation.from_rotvec(params[0:3]))
    t2 = params[3:6]
    #f1, f2 = params[6:8]

    # camera_params[0]["intrinsic_matrix"][0,0] = f1
    # camera_params[0]["intrinsic_matrix"][1,1] = f1
    # camera_params[0]["intrinsic_matrix"][0,2] = ox1
    # camera_params[0]["intrinsic_matrix"][1,2] = oy1

    # camera_params[1]["intrinsic_matrix"][0,0] = f2
    # camera_params[1]["intrinsic_matrix"][1,1] = f2
    # camera_params[1]["intrinsic_matrix"][0,2] = ox2
    # camera_params[1]["intrinsic_matrix"][1,2] = oy2

    object_points = triangulate_points(points, r1, t1, r2, t2)


    projected_img_points_1,_ = cv.projectPoints(object_points, np.eye(3), np.zeros(3), camera_params[0]["intrinsic_matrix"], camera_params[0]["distortion_coef"])
    projected_img_points_1 = projected_img_points_1[:,0,:]
    projected_img_points_2,_ = cv.projectPoints(object_points, Rs[chosen_rt], ts[chosen_rt], camera_params[1]["intrinsic_matrix"], camera_params[1]["distortion_coef"])
    projected_img_points_2 = projected_img_points_2[:,0,:]
    residuals = np.concatenate([(points[:,0]-projected_img_points_1)**2, (points[:,1]-projected_img_points_2)**2]).flatten()
    #residuals = ((image_points[:,1]-projected_img_points_2)**2).flatten()

    if viz:
        object_points = triangulate_points(image_points, r1, t1, r2, t2)
        visualize(image_points, object_points, r1, t1, r2, t2)

    return residuals

r2_rotvec = Rotation.as_rotvec(Rotation.from_matrix(Rs[chosen_rt]))
x0 = np.concatenate([
    r2_rotvec, 
    ts[chosen_rt].T[0], 
    # [camera_params[0]["intrinsic_matrix"][0,0]], 
    # [camera_params[1]["intrinsic_matrix"][0,0]],
    # [camera_params[0]["intrinsic_matrix"][0,2]],
    # [camera_params[0]["intrinsic_matrix"][1,2]],
    # [camera_params[1]["intrinsic_matrix"][0,2]],
    # [camera_params[1]["intrinsic_matrix"][1,2]], 
])
f0 = residuals(x0, True)
plt.plot(f0)
plt.show()

res = optimize.least_squares(
    residuals, x0, verbose=2, 
    bounds=(
        [-np.inf, -np.inf, -np.inf, -np.inf, -np.inf, -np.inf], 
        [np.inf, np.inf, np.inf, np.inf, np.inf, np.inf]
    )
)

print(x0)
print(res.x)

residuals(res.x, True)

plt.plot(res.fun)
plt.show()

# params = np.array([-3.66445627e-02, 1.11852224e+00, 2.31428415e-02, -8.57352986e-01, 5.94394316e-03, 5.07427474e-01, 2.71810323e+02, 120, 1.61783144e+02])
# residuals(params, True)

# def drawlines(img1,img2,lines,pts1,pts2):
#     ''' img1 - image on which we draw the epilines for the points in img2
#     lines - corresponding epilines '''
#     r,c = img1.shape
#     img1 = cv.cvtColor(img1,cv.COLOR_GRAY2BGR)
#     img2 = cv.cvtColor(img2,cv.COLOR_GRAY2BGR)
#     for r,pt1,pt2 in zip(lines,pts1,pts2):
#         color = tuple(np.random.randint(0,255,3).tolist())
#         x0,y0 = map(int, [0, -r[2]/r[1] ])
#         x1,y1 = map(int, [c, -(r[2]+r[0]*c)/r[1] ])
#         img1 = cv.line(img1, (x0,y0), (x1,y1), color,1)
#         img1 = cv.circle(img1,tuple(pt1),5,color,-1)
#         img2 = cv.circle(img2,tuple(pt2),5,color,-1)
#     return img1,img2

# # Find epilines corresponding to points in right image (second image) and
# # drawing its lines on left image
# lines1 = cv.computeCorrespondEpilines(pts2.reshape(-1,1,2), 2,F)
# lines1 = lines1.reshape(-1,3)
# img5,img6 = drawlines(img1,img2,lines1,pts1,pts2)

# # Find epilines corresponding to points in left image (first image) and
# # drawing its lines on right image
# lines2 = cv.computeCorrespondEpilines(pts1.reshape(-1,1,2), 1,F)
# lines2 = lines2.reshape(-1,3)
# img3,img4 = drawlines(img2,img1,lines2,pts2,pts1)
# plt.subplot(121),plt.imshow(img5)
# plt.subplot(122),plt.imshow(img3)
# plt.show()